# 压缩列表

压缩列表（ziplist）是列表键和哈希键的底层实现之一。压缩列表是redis为了节约内存而开发的，是由一系列特殊编码的连续内存块组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组和一个整数值。

`[zlbytes][zltail][zllen][entry1][entry2]...[zlend]`

压缩列表组成部分说明：

| 属性    | 类型     | 长度 | 用途                                                         |
| ------- | -------- | ---- | ------------------------------------------------------------ |
| zlbytes | uint32_t | 4    | 记录整个压缩列表占用的内存字节数，对压缩列表进行内存重分配或计算zlend的位置时使用 |
| zltail  | uint32_t | 4    | 记录压缩列表尾节点距离压缩列表的起始地址多少个字节，通过这个偏移量，程序无需遍历整个压缩列表就能确定尾节点的地址。 |
| zllen   | uint16_t | 2    | 记录了压缩列表的节点数量，当值小于65535时，该值就是节点的数量。当等于65535时，节点的真实数量需要遍历整个压缩列表才能计算得出 |
| entryX  | 列表节点 | 不定 | 压缩列表包含的节点，节点的长度由节点保存的内容决定           |
| zlend   | uint8_t  | 1    | 特殊值0xFF（十进制255），用于标记压缩列表的末端              |



压缩列表的节点（entry）构成

每个压缩列表节点可以保存一个字节数组或一个整数值。

字节数组可以是以下三种长度的一种：

1.长度小于等于63（2^6-1）字节

2.长度小于等于16383（2^14-1）字节

3.长度小于等于4294967295（2^32-1）字节

整数值可以是以下六种长度的其中一种：

1.4位长，介于0-12之间的无符号整数

2.1字节长的有符号整数

3.3字节长的有符号整数

4.int16_t类型整数

5.int32_t类型整数

6.int64_t类型整数



每个压缩列表节点都由previous_entry_length、encoding、content三个部分组成

`[previous_entry_length][encoding][content]`

previous_entry_length：

以字节为单位，记录了压缩列表中前一个节点的长度，该字段长度可以是1字节或5字节。如果前一节点长度小于254字节，那么该字段长度为1字节，前一节点的长度就保存在这一字节里。如果前一节点的长度大于等于254字节，那么该字段长度为5字节，第一字节会被设置为0xFE（十进制254），后面的四个字节用于保存前一节点的长度。

encoding：

记录了节点的content属性所保存数据的类型及长度：

1.1字节、2字节或5字节长，值的高位为00、01、10的是字节数组编码，表示content存的是字节数组，长度由编码除去最高两位后的其他位记录。

2.1字节长，值的高位由11开头的是整数编码，整数值的类型和长度由编码除去最高两位后的其他位记录。

字节数组编码：

| 高位编码 | 编码长度 | content值                            |
| -------- | -------- | ------------------------------------ |
| 00       | 1字节    | 长度小于等于63字节的字节数组         |
| 01       | 2字节    | 长度小于等于16383字节的字节数组      |
| 10       | 5字节    | 长度小于等于4294967295字节的字节数组 |

整数编码：

| 编码     | 编码长度 | content值       |
| -------- | -------- | --------------- |
| 11000000 | 1字节    | int16_t类型整数 |
| 11010000 | 1字节    | int32_t类型整数 |
| 11100000 | 1字节    | int64_t类型整数 |
| 11110000 | 1字节    | 24位有符号整数  |
| 11111110 | 1字节    | 8位有符号整数   |
| 1111xxxx | 1字节    | 无content属性   |



content：

负责保存节点的值，节点值可以是一个字节数组或整数，类型和长度由encoding字段决定。 